---
const title = 'Ad Page';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style is:global>
      * {
        margin: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #050608;
        color: #f7f3ea;
      }

      .wrap {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .card {
        width: 80vw;
        max-width: 900px;
        background: #090a10;
        border-radius: 12px;
        padding: 20px 18px 16px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.55);
        border: 1px solid #3b2a1a;
        text-align: center;
      }

      .title {
        font-size: 1.25rem;
        margin-bottom: 6px;
        color: #f6b756;
      }

      .text {
        font-size: 0.9rem;
        color: #b3a9a0;
        margin-bottom: 10px;
      }

      .small {
        font-size: 0.75rem;
        color: #b3a9a0;
        margin-top: 8px;
      }

      .ad-wrap {
        margin-top: 8px;
      }

      #video-ad {
        width: 100%;
        max-width: 640px;
        height: 360px;
        background: #000;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="title">Preparing your gameâ€¦</div>
        <p class="text">
          Your game is loading in the background. This support page helps keep
          Burrito Edition online for everyone.
        </p>

        <div class="ad-wrap">
          <video id="video-ad" playsinline muted controls></video>
        </div>

        <p class="small">
          You can close this window once your game has started. Thanks for
          supporting Burrito Edition!
        </p>
      </div>
    </div>

    <script is:inline>
      (function () {
        const vastUrl =
          "https://pubads.g.doubleclick.net/gampad/live/ads?iu=/23335597477/VAST_SITE&description_url=https%3A%2F%2Fburritoedition.com%2Fad%2F&tfcd=0&npa=0&sz=640x480&ciu_szs=300x250%2C336x280&gdfp_req=1&unviewed_position_start=1&output=vast&env=vp&impl=s&correlator=" +
          Date.now();

        const video = document.getElementById("video-ad");
        if (!video) return;

        function parseVAST(xmlText) {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");

          // Check for parse errors
          if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
            console.error("VAST XML parse error");
            return null;
          }

          // Try to find MediaFile in Linear/Inline structure
          const linearAds = xmlDoc.querySelectorAll("Linear");
          for (const linear of linearAds) {
            const mediaFiles = linear.querySelectorAll("MediaFile");
            for (const mediaFile of mediaFiles) {
              const type = mediaFile.getAttribute("type") || "";
              const url = mediaFile.textContent.trim();
              
              // Prefer video/mp4, but accept other types
              if (url && (type.includes("video/mp4") || type.includes("video"))) {
                return url;
              }
            }
          }

          // Fallback: get any MediaFile
          const anyMediaFile = xmlDoc.querySelector("MediaFile");
          if (anyMediaFile) {
            return anyMediaFile.textContent.trim();
          }

          return null;
        }

        fetch(vastUrl)
          .then((r) => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.text();
          })
          .then((xmlText) => {
            console.log("VAST response received");
            const mediaUrl = parseVAST(xmlText);
            
            if (mediaUrl) {
              console.log("Media URL:", mediaUrl);
              video.src = mediaUrl;
              video.play().catch((err) => console.error("Playback error:", err));
            } else {
              console.warn("No valid media file found in VAST response");
            }
          })
          .catch((err) => console.error("VAST load error:", err));
      })();
    </script>

    <!-- Google Analytics Tags -->
    <script
      is:inline
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-TW1C8W4K8F"
    ></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-TW1C8W4K8F");
    </script>
  </body>
</html>
